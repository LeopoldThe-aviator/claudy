<% if @date.month == Date.today.month && @date.year == Date.today.year && (@grouped_reservations[Date.today].any? || grouped_space_reservations[Date.today].any?) %>
  <div class="mb-4 p-4 pb-1 bg-lime-50 rounded shadow">
    <h2 class="font-light">Aujourd'hui aux 4 Sources</h2>

    <% notes = Note.where(date: Date.today).order(id: :desc) %>
    <% if notes.any? %>
      <div class="mb-4 space-y-4">
        <%= render Note.where(date: Date.today).order(id: :desc) %>
      </div>
    <% end %>

    <div class="flex mb-4 grid grid-cols-3 gap-4">
      <% if @grouped_reservations[Date.today].any? %>
        <% @grouped_reservations[Date.today].sort_by {|r| r.start_time }.group_by { |r| r.booking.id }.each do |grouped_reservations| %>
          <% reservation = grouped_reservations.last.first %>
          <% booking = BookingDecorator.new(reservation.booking) %>
          <div class="place-self-stretch text-sm font-light text-gray-500 bg-white border border-gray-200 rounded-lg shadow-sm">
            <%= render "bookings/popover", booking: booking %>
          </div>
        <% end %>
      <% end %>

      <% if @grouped_space_reservations[Date.today].any? %>
        <% @grouped_space_reservations[Date.today].sort_by {|r| r.start_time }.group_by { |r| r.space_booking.id }.each do |grouped_space_reservations| %>
          <% space_reservation = grouped_space_reservations.last.first %>
          <% space_booking = SpaceBookingDecorator.new(space_reservation.space_booking) %>
          <div class="place-self-stretch text-sm font-light text-gray-500 bg-white border border-gray-200 rounded-lg shadow-sm">
            <%= render "space_bookings/popover", space_booking: space_booking %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
<% end %>

<% current_month = date_range.first.month %>
<div class="lg:flex lg:h-full lg:flex-col" data-controller="dashboard-calendar" data-action="click->dashboard-calendar#clickCalendar">
  <div class="shadow ring-1 ring-black ring-opacity-5 lg:flex lg:flex-auto lg:flex-col">
    <% date_range.each_slice(7).with_index do |weekdays, index| %>
      <% if index == 0 %>
        <div class="grid grid-cols-7 gap-px border-b border-gray-300 bg-gray-200 text-center text-xs font-semibold leading-6 text-gray-700 lg:flex-none">
          <% weekdays.each do |day| %>
            <div class="flex justify-center bg-white py-2">
              <span><%= l(day, format: "%A") %></span>
            </div>
          <% end %>
        </div>
      <% end %>
    <% end %>
    <div class="flex bg-gray-200 text-xs leading-6 text-gray-700 lg:flex-auto">
      <div class="hidden w-full lg:grid lg:grid-cols-7 lg:gap-px">
        <% date_range.each do |day| %>
          <% month_classes = (day.month == Date.today.month && day.year == Date.today.year) ? "bg-white" : "bg-gray-50 text-gray-500" %>
          <div class="relative py-2 px-3 text-gray-700 <%= month_classes %> <%= (Date.today == day) ? "bg-sky-50" : nil %> <%= (Date.today > day) ? "opacity-70" : nil %>">
            <div class="flex place-content-between">
              <% day_classes = day == Date.today ? "flex px-2 h-6 items-center justify-center rounded-lg bg-indigo-600 font-semibold text-white" : "flex px-2 h-6 bg-blue-100 items-center justify-center rounded-lg border border-blue-300 font-semibold" %>
              <%= link_to day_details_path(date: day.strftime("%Y-%m-%d")), class: "claudy-link border-0", data: { turbo_frame: "modal" } do %>
                <time datetime="<%= l(day, format: "%Y-%m-%d") %>" class="<%= day_classes %>">
                  <% if current_month != day.month %>
                    <% current_month = day.month %>
                    <%= l(day, format: "%e %b") %>
                  <% else %>
                    <%= l(day, format: "%e") %>
                  <% end %>
                </time>
              <% end %>

              <div class="flex">
                <% if Date.today <= day %>
                  <%= link_to "H+", new_booking_path(date: day.strftime("%Y-%m-%d")), class: "mr-2 text-blue-700 hover:text-blue-900" %>
                  <%= link_to "E+", new_space_booking_path(date: day.strftime("%Y-%m-%d")), class: "mr-2 text-blue-700 hover:text-blue-900" %>
                <% end %>

                <%= link_to new_note_path(date: day.strftime("%Y-%m-%d")), data: { turbo_frame: "modal" } do %>
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="mt-1 w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                  </svg>
                <% end %>
              </div>
            </div>

            <div id="notes-<%= day %>">
              <%= render Note.where(date: day).order(id: :desc) %>
            </div>

            <% passed_block.call day, sorted_events.fetch(day, []) %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>